box: node:4-slim

initial-build:
  steps:
    - install-packages:
        packages: bzip2

    - script:
        name: setup node env
        code: |
          export NODE_ENV=development

    - npm-install

tests:
  steps:
    - script:
        name: setup node env
        code: |
          export NODE_ENV=development

    - script:
        name: run tests
        code: |
          npm test

release-build:
  steps:
    - script:
        name: npm rebuild
        code: |
          npm rebuild

    - script:
        name: build release code
        code: |
          npm run build
          mv ./build/* $WERCKER_OUTPUT_DIR

push-debug:
  steps:
    - internal/docker-push:
        repository: quay.io/wercker/todo-demo-debug
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        registry: quay.io
        tag: $WERCKER_GIT_BRANCH
        working-dir: /pipeline/source
        cmd: npm start

push-release:
  box:
    id: nginx:alpine
    cmd: /bin/sh
  steps:
    - script:
        name: mv static files
        code: |
          rm -rf /usr/share/nginx/html/*
          mv $WERCKER_SOURCE_DIR/* /usr/share/nginx/html

    - script:
        name: cleanup build result
        code: |
          rm -rf *

    - internal/docker-push:
        disable-sync: true
        repository: quay.io/wercker/todo-demo-release
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        registry: quay.io
        tag: $WERCKER_GIT_BRANCH
        cmd: nginx -g 'daemon off;'
